name: Rose

on:
  pull_request:
    types:
      - closed
    branches:
      - main
      - dev
      - master
  workflow_dispatch:
    inputs:
      base_ref:
        description: 'Baseref (main)'
        required: true
        default: 'main'
      head_ref:
        description: 'Headref (feature branch)'
        required: true
        default: ''
      languages:
        description: 'ISO Codes of target languages (space-separated)'
        required: true
        default: ''
      include_full:
        description: 'Set to true to send full files (even if only a line changed)'
        required: false
        default: 'false'
      file_filter:
        description: 'Separated list of files to translate (repo-relative paths)'
        required: false
        default: ''

permissions:
  contents: write
  pull-requests: write

jobs:
  guard:
    runs-on: ubuntu-latest
    outputs:
      allowed: ${{ steps.permission_check.outputs.allowed }}
      merged_by_allowed: ${{ steps.merged_actor_check.outputs.allowed || steps.permission_check.outputs.allowed }}
    steps:
      - name: Verify maintainer permissions
        id: permission_check
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const actor = context.actor;
            const { data } = await github.rest.repos.getCollaboratorPermissionLevel({
              owner: context.repo.owner,
              repo: context.repo.repo,
              username: actor,
            });
            const permission = (data && data.permission) ? data.permission : 'none';
            core.info(`Actor ${actor} has permission level: ${permission}`);
            const allowedPermissions = new Set(['admin', 'maintain']);
            const allowed = allowedPermissions.has(permission) ? 'true' : 'false';
            core.setOutput('allowed', allowed);
      - name: Halt unauthorized dispatch
        if: ${{ steps.permission_check.outputs.allowed != 'true' }}
        run: |
          echo "::warning::${{ github.actor }} is not an admin/maintainer on this repository; skipping pipeline."
      - name: Verify merged-by permissions
        if: ${{ github.event_name == 'pull_request' && github.event.pull_request.merged == true }}
        id: merged_actor_check
        uses: actions/github-script@v7
        env:
          DISPATCH_ALLOWED: ${{ steps.permission_check.outputs.allowed }}
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const mergedBy = context.payload.pull_request.merged_by?.login;
            const fallback = process.env.DISPATCH_ALLOWED === 'true' ? 'true' : 'false';
            if (!mergedBy) {
              core.setOutput('allowed', fallback);
              core.info('Pull request merge has no merged_by; falling back to dispatcher permissions.');
              return;
            }
            const { data } = await github.rest.repos.getCollaboratorPermissionLevel({
              owner: context.repo.owner,
              repo: context.repo.repo,
              username: mergedBy,
            });
            const permission = (data && data.permission) ? data.permission : 'none';
            const allowedPermissions = new Set(['admin', 'maintain']);
            const allowed = allowedPermissions.has(permission) ? 'true' : 'false';
            core.info(`Merged-by actor ${mergedBy} has permission level: ${permission}`);
            core.setOutput('allowed', allowed);

  run-pipeline:
    name: Rose's Translation Pipeline
    environment: translations
    needs: guard
    if: ${{ needs.guard.outputs.allowed == 'true' && (github.event_name != 'pull_request' || (github.event.pull_request.merged == true && needs.guard.outputs.merged_by_allowed == 'true')) }}
    runs-on: ubuntu-latest
    env:
      N8N_WEBHOOK_URL: ${{ secrets.N8N_WEBHOOK_URL_TR }}
      ROSE_N8N_SENDING_TOKEN: ${{ secrets.N8N_SENDING_TOKEN || '' }}
      ROSE_N8N_RECEIVING_TOKEN: ${{ secrets.N8N_RECEIVING_TOKEN || '' }}
      ROSE_N8N_ALLOWED_HOST: ${{ vars.N8N_ALLOWED_HOST || '' }}
      ROSE_QUIET: "1"
      ROSE_MASK_PAYLOAD: "1"
      ROSE_INCLUDE_FILES: ${{ github.event_name == 'workflow_dispatch' && inputs.file_filter || '' }}
      ROSE_INCLUDE_FULL: ${{ github.event_name == 'workflow_dispatch' && inputs.include_full || '' }}
      ROSE_LANGUAGES: ${{ vars.ROSE_LANGUAGES }}
      ROSE_TRANSLATION_BRANCH: rose/translations
    steps:
      - name: Determine translation parameters
        id: refs
        shell: bash
        run: |
          DEFAULT_LANGS="${ROSE_LANGUAGES:-es fr pt}"
          normalize_ref() {
            local ref="$1"
            if [[ -z "$ref" ]]; then
              echo ""
            elif [[ "$ref" == "HEAD" ]]; then
              echo "$ref"
            elif [[ "$ref" =~ ^[0-9a-f]{7,40}$ ]]; then
              echo "$ref"
            elif [[ "$ref" == refs/heads/* ]]; then
              echo "origin/${ref#refs/heads/}"
            elif [[ "$ref" == origin/* ]]; then
              echo "$ref"
            elif [[ "$ref" == refs/* ]]; then
              echo "$ref"
            else
              echo "origin/$ref"
            fi
          }
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            raw_base="${{ inputs.base_ref }}"
            raw_head="${{ inputs.head_ref }}"
            if [[ -z "${{ inputs.languages }}" ]]; then
              echo "languages input is required for manual dispatch (e.g., \"es fr pt\")" >&2
              exit 1
            fi
            diff_base="$(normalize_ref "$raw_base")"
            diff_head="$(normalize_ref "$raw_head")"
            pr_base="$raw_head"
            langs="${{ inputs.languages }}"
          elif [[ "${{ github.event_name }}" == "pull_request" ]]; then
            raw_base="${{ github.event.pull_request.base.ref }}"
            raw_head="${{ github.event.pull_request.head.ref }}"
            diff_base="${{ github.event.pull_request.base.sha }}"
            diff_head="${{ github.event.pull_request.head.sha }}"
            pr_base="${{ github.event.pull_request.base.ref }}"
            langs="$DEFAULT_LANGS"
          else
            branch="${GITHUB_REF_NAME:-${GITHUB_REF##*/}}"
            diff_base="${{ github.event.before }}"
            if [[ -z "$diff_base" || "$diff_base" == "0000000000000000000000000000000000000000" ]]; then
              diff_base="origin/${branch}"
            fi
            diff_head="HEAD"
            pr_base="${branch}"
            langs="$DEFAULT_LANGS"
          fi
          echo "diff_base=$diff_base" >> "$GITHUB_OUTPUT"
          echo "diff_head=$diff_head" >> "$GITHUB_OUTPUT"
          echo "pr_base=$pr_base" >> "$GITHUB_OUTPUT"
          echo "languages=$langs" >> "$GITHUB_OUTPUT"

      # 1) Fetch the repo so the pipeline can diff and modify files.
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Fetch manual dispatch refs
        if: ${{ github.event_name == 'workflow_dispatch' }}
        shell: bash
        env:
          RAW_BASE: ${{ inputs.base_ref }}
          RAW_HEAD: ${{ inputs.head_ref }}
          DIFF_BASE: ${{ steps.refs.outputs.diff_base }}
          DIFF_HEAD: ${{ steps.refs.outputs.diff_head }}
        run: |
          set -euo pipefail
          fetch_ref() {
            local raw="$1"
            local normalized="$2"
            if [[ -z "$raw" || "$raw" == "HEAD" || "$raw" =~ ^[0-9a-f]{7,40}$ ]]; then
              return
            fi
            if [[ "$normalized" == origin/* ]]; then
              git fetch origin "${normalized#origin/}"
            else
              git fetch origin "$normalized:$normalized"
            fi
          }
          fetch_ref "$RAW_BASE" "$DIFF_BASE"
          fetch_ref "$RAW_HEAD" "$DIFF_HEAD"

      # 2) Install a consistent Python interpreter for all helper scripts.
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install translation workflow dependencies
        run: |
          python -m pip install --upgrade pip
          pip install PyYAML ruamel.yaml Babel

      # 3) Kick off Rose's orchestrator (diff → n8n → verify → build).
      - name: Run Rose pipeline
        shell: bash
        run: |
          set -euo pipefail

          # Abort early if the webhook secret is missing.
          if [[ -z "${N8N_WEBHOOK_URL:-}" ]]; then
            echo "N8N_WEBHOOK_URL_TR secret is required" >&2
            exit 1
          fi

          LANGS="${{ steps.refs.outputs.languages }}"
          export ROSE_PRESERVE_TRANSLATIONS=1

          CMD=(python scripts/translation-workflow/rose_pipeline.py \
            --base "${{ steps.refs.outputs.diff_base }}" \
            --head "${{ steps.refs.outputs.diff_head }}" \
            --n8n-webhook "$N8N_WEBHOOK_URL")

          # Pass down the language list one by one.
          CMD+=(--languages)
          for lang in $LANGS; do
            CMD+=("$lang")
          done

          echo "Running: ${CMD[*]}"
          "${CMD[@]}"

      - name: Prepare temporary summary directory
        if: ${{ always() }}
        id: temp_summary
        run: |
          TMP_DIR=$(mktemp -d)
          echo "dir=$TMP_DIR" >> "$GITHUB_OUTPUT"

      - name: Generate summary markdown
        if: ${{ always() }}
        shell: bash
        run: |
          SUMMARY_JSON="scripts/translations/summary_report.json"
          SUMMARY_MD="${{ steps.temp_summary.outputs.dir }}/summary.md"
          if [[ ! -f "$SUMMARY_JSON" ]]; then
            echo '{}' > "$SUMMARY_JSON"
          fi
          python scripts/translation-workflow/render_summary.py \
            --summary "$SUMMARY_JSON" \
            --output "$SUMMARY_MD"

      - name: Append translation summary to job summary
        if: ${{ always() }}
        shell: bash
        run: |
          SUMMARY_MD="${{ steps.temp_summary.outputs.dir }}/summary.md"
          if [[ -f "$SUMMARY_MD" ]]; then
            cat "$SUMMARY_MD" >> "$GITHUB_STEP_SUMMARY"
          else
            echo "Summary markdown not found; skipping job summary update."
          fi

      - name: Cleanup translation artifacts
        if: ${{ always() }}
        run: rm -rf scripts/translations

      - name: Push translation branch
        id: push_branch
        shell: bash
        env:
          TRANSLATION_BRANCH: ${{ env.ROSE_TRANSLATION_BRANCH }}
          COMMIT_MESSAGE: "chore(rose): sync translations for ${{ steps.refs.outputs.languages }}"
        run: |
          set -euo pipefail
          restore_commit="$(git rev-parse HEAD)"
          restore_branch="$(git symbolic-ref --quiet --short HEAD || true)"
          changes="$(git status --porcelain)"
          echo "branch=${TRANSLATION_BRANCH}" >> "$GITHUB_OUTPUT"
          if [[ -z "$changes" ]]; then
            echo "No translation changes detected; skipping branch push."
            echo "pushed=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git fetch origin "$TRANSLATION_BRANCH":"refs/remotes/origin/$TRANSLATION_BRANCH" || true
          git branch -D "$TRANSLATION_BRANCH" 2>/dev/null || true
          git checkout -B "$TRANSLATION_BRANCH"
          git add -A
          if git diff --cached --quiet; then
            echo "No staged changes to commit; skipping branch push."
            if [[ -n "$restore_branch" ]]; then
              git checkout "$restore_branch"
            else
              git checkout --detach "$restore_commit"
            fi
            echo "pushed=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi
          git commit -m "$COMMIT_MESSAGE"
          git push --force-with-lease origin "$TRANSLATION_BRANCH"
          if [[ -n "$restore_branch" ]]; then
            git checkout "$restore_branch"
          else
            git checkout --detach "$restore_commit"
          fi
          echo "pushed=true" >> "$GITHUB_OUTPUT"

      - name: Post translation branch instructions
        if: ${{ always() }}
        shell: bash
        env:
          TRANSLATION_BRANCH: ${{ steps.push_branch.outputs.branch }}
          PUSHED: ${{ steps.push_branch.outputs.pushed }}
          BASE_BRANCH: ${{ steps.refs.outputs.pr_base }}
        run: |
          if [[ -z "${TRANSLATION_BRANCH}" ]]; then
            exit 0
          fi
          {
            echo "### Translation branch"
            echo ""
            if [[ "${PUSHED}" == "true" ]]; then
              echo "- Branch with translations: \`${TRANSLATION_BRANCH}\`"
              echo "- Base branch: \`${BASE_BRANCH}\`"
              echo "- Summary file: \`scripts/translations/summary_report.json\`"
              echo ""
              echo "Open a pull request manually from the rose/translations branch above"
            else
              echo "- No translation changes were committed during this run."
            fi
          } >> "$GITHUB_STEP_SUMMARY"
      - name: Verify merged-by permissions
        if: ${{ github.event_name == 'pull_request' && github.event.pull_request.merged == true }}
        id: merged_actor_check
        uses: actions/github-script@v7
        env:
          DISPATCH_ALLOWED: ${{ steps.permission_check.outputs.allowed }}
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const mergedBy = context.payload.pull_request.merged_by?.login;
            const fallback = process.env.DISPATCH_ALLOWED === 'true' ? 'true' : 'false';
            if (!mergedBy) {
              core.setOutput('allowed', fallback);
              core.info('Pull request merge has no merged_by; falling back to dispatcher permissions.');
              return;
            }
            const { data } = await github.rest.repos.getCollaboratorPermissionLevel({
              owner: context.repo.owner,
              repo: context.repo.repo,
              username: mergedBy,
            });
            const permission = (data && data.permission) ? data.permission : 'none';
            const allowedPermissions = new Set(['admin', 'maintain']);
            const allowed = allowedPermissions.has(permission) ? 'true' : 'false';
            core.info(`Merged-by actor ${mergedBy} has permission level: ${permission}`);
            core.setOutput('allowed', allowed);
